1. Function层 (最外层入口) - 只做最基础的HTTP适配。具体内容委托给Handler，保持Function简洁
2. Handler层 (协调层) - 协调整个处理流程。验证请求有效性，根据操作类型路由， 统一异常处理。解析请求体；调用业务服务；构建HTTP响应。
3. Service层 (业务逻辑层) - 纯粹的业务逻辑。业务规则验证，业务逻辑等。




```
// 1. Function层 (最外层入口)
// GenericCrudFunction.java - 只做最基础的HTTP适配
public class GenericCrudFunction {
    @FunctionName("GenericCrud")
    public HttpResponseMessage execute(
        @HttpTrigger(...) HttpRequestMessage<Optional<String>> request,
        @BindingName("table") String tableName,
        final ExecutionContext context) {
        
        // 委托给Handler，保持Function简洁
        return handler.handle(request, tableName, context);
    }
}

// 2. Handler层 (协调层)
// GenericCrudHandler.java - 协调整个处理流程
public class GenericCrudHandler {
    public HttpResponseMessage handle(HttpRequestMessage<?> request, 
                                      String tableName,
                                      ExecutionContext context) {
        
        try {
            // 验证请求有效性
            ValidationResult validation = validator.validateRequest(request, tableName);
            if (!validation.isValid()) {
                return buildValidationErrorResponse(request, validation);
            }
            
            // 根据操作类型路由
            CrudOperation operation = determineOperation(request);
            switch (operation) {
                case CREATE:
                    return handleCreate(request, tableName);
                case READ:
                    return handleRead(request, tableName);
                // ... 其他操作
            }
        } catch (Exception e) {
            // 统一异常处理
            return exceptionHandler.handle(request, e);
        }
    }
    
    private HttpResponseMessage handleCreate(HttpRequestMessage<?> request, 
                                             String tableName) {
        // 1. 解析请求体
        Map<String, Object> data = parseRequestBody(request);
        
        // 2. 调用业务服务
        Map<String, Object> result = crudService.create(tableName, data);
        
        // 3. 构建HTTP响应
        return responseBuilder.buildSuccessResponse(request, result, 201);
    }
}

// 3. Service层 (业务逻辑层)
// GenericCrudService.java - 纯粹的业务逻辑
public class GenericCrudService {
    public Map<String, Object> create(String tableName, Map<String, Object> data) {
        // 1. 业务规则验证
        if (!tableRegistry.isTableWritable(tableName)) {
            throw new BusinessException(ErrorCode.TABLE_NOT_WRITABLE);
        }
        
        // 2. 数据补充（业务逻辑）
        data.put("id", generateId());
        data.put("createdAt", Instant.now());
        data.put("createdBy", getCurrentUser());
        
        // 3. 数据持久化
        Map<String, Object> saved = repository.insert(tableName, data);
        
        // 4. 业务事件触发
        eventPublisher.publishEntityCreated(tableName, saved);
        
        return saved;
    }
}
```


## 提议的 v4 架构设计

### 1. 新的包结构设计

```javascript
com.yugabyte.crud (根包)
├── api (Function层/API层)
│   ├── function
│   ├── dto
│   └── validator
├── application (Handler层/应用层)
│   ├── handler
│   ├── service (应用服务)
│   ├── dto
│   └── processor
├── domain (领域层/业务逻辑层)
│   ├── service (领域服务)
│   ├── repository
│   ├── model
│   ├── exception
│   └── rule
└── infrastructure (基础设施层)
    ├── persistence
    ├── util
    ├── config
    └── cache
```

### 2. 各层职责明确划分

__Function层 (API层)__：

- 只做HTTP适配，接收请求并返回响应
- 基本参数验证（如表名、HTTP方法）
- 异常捕获并转换为HTTP状态码
- 委托给Handler层处理具体业务

__Handler层 (应用层)__：

- 协调整个处理流程
- 请求有效性验证
- 根据操作类型路由到相应服务
- 统一异常处理
- 解析请求体，调用业务服务，构建HTTP响应

__Service层 (领域层)__：

- 纯粹的业务逻辑
- 业务规则验证
- 领域模型操作
- 不直接操作数据库，通过Repository抽象

### 3. 具体类设计建议

__Function层__：

- `CrudFunction`：Azure Function入口点，保持简洁
- `ApiRequestValidator`：API级别的基本验证

__Handler层__：

- `CrudHandler`：协调CRUD操作流程
- `RequestProcessor`：请求解析和转换
- `ResponseBuilder`：标准化响应构建
- `ExceptionHandler`：统一异常处理

__Service层__：

- `CrudService`：核心CRUD业务逻辑
- `TableMetadataService`：表元数据管理
- `DataValidationService`：数据验证服务

__Repository层__：

- `TableRepository`：表操作的数据访问抽象
- `QueryBuilder`：SQL构建职责分离
- `DatabaseMetadataRepository`：数据库元数据访问

### 4. 请求处理流程

1. __HTTP请求到达__ → `CrudFunction.run()`
2. __Function层__ → 基本验证（表名、HTTP方法）→ 委托给 `CrudHandler`
3. __Handler层__ → 请求解析 → 调用相应的 `CrudService` 方法
4. __Service层__ → 业务逻辑验证 → 调用 `TableRepository`
5. __Repository层__ → 执行数据库操作
6. __结果返回__ → Service → Handler → ResponseBuilder构建响应 → Function返回HTTP响应

### 5. 关键改进点

1. __单一职责原则__：每个类/层只做一件事
2. __依赖倒置__：高层模块不依赖低层模块，都依赖抽象
3. __接口隔离__：定义清晰的接口边界
4. __开闭原则__：对扩展开放，对修改关闭
5. __测试友好__：各层可独立测试，易于Mock

### 6. 命名规范建议

- 移除版本后缀（v3/v4），使用语义化包名
- 类名体现职责：`XxxService`、`XxxRepository`、`XxxHandler`
- 方法名体现操作：`create`、`read`、`update`、`delete`
